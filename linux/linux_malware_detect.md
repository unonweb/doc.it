# LINKS

- https://www.rfxn.com/projects/linux-malware-detect/
- https://github.com/rfxn/linux-malware-detect/tree/master

# INSTALL

```sh
# install
wget https://www.rfxn.com/downloads/maldetect-current.tar.gz
tar -zxvf maldetect-current.tar.gz
```

# CONFIG

```sh
sudo nano /usr/local/maldetect/conf.maldet

# As a design and common use case, LMD typically only scans user space paths
# and as such it makes sense to ignore files that are root owned. It is
# recommended to leave this enabled for best performance.
# [ 0 = disabled, 1 = enabled ]
scan_ignore_root="0"
```

## ignore

There are four ignore files available and they break down as follows:

```sh
sudo nano /usr/local/maldetect/ignore_paths
# A line spaced file for paths that are to be excluded from search results
# /home/user/public_html/cgi-bin

sudo nano /usr/local/maldetect/ignore_file_ext
# A line spaced file for file extensions to be excluded from search results
# .js
# .css

sudo nano /usr/local/maldetect/ignore_sigs
# A line spaced file for signatures that should be removed from file scanning
# base64.inject.unclassed

sudo nano /usr/local/maldetect/ignore_inotify
# A line spaced file for regexp paths that are excluded from inotify monitoring
# ^/home/user$
# ^/var/tmp/#sql_.*\.MYD$
```
# CRON

/etc/cron.daily/maldet

```sh
sudo nano /etc/cron.daily/maldet
# perform a daily update of signatures
# keep the session, temp and quarantine data to no more than 14d old
# run a daily scan of recent file system changes
```

/etc/cron.d/maldet_pub

```sh
sudo nano /etc/cron.d/maldet_pub
*/5 * * * * root /usr/local/maldetect/maldet --mkpubpaths >> /dev/null 2>&1
# Every 5 Minutes
```

- required for **MODSECURITY2 UPLOAD SCANNING**

The nature of uploads is such that they are performed either under the user that the HTTP
service is running as or under that of a system user in an suexec style setup (i.e: phpsuexec). This required a change to the way LMD stores session, temporary and quarantine data to allow for non-root users to perform scans.

Given that the maldetect installation path is owned by user root, we either need to set a pub
path world writable (777) or populate the pub path with user owned paths. It was undesirable to set any path world writable and as such a feature to populate path data was created. This feature is controlled with the `--mkpubpaths` flag and is executed from cron every 10 minutes, it will only execute if the scan_user_access variable is enabled in conf.maldet. As such, it is important to make sure the scan_user_access variable is set to enabled (1) in conf.maldet and it is advised to run 'maldet --mkpubpaths' manually to prepopulate the user paths. There after, the cron will ensure new users have paths created no later than 10 minutes after creation.
# CLI

```bash
sudo maldet --help

maldet -a
maldet --scan-all PATH # Scan all files in path (default: /home, wildcard: ?)
maldet -a /home/?/public_html

maldet -f
maldet --file-list # Scan files or paths defined in line spaced file
maldet -f /root/scan_file_list

maldet -r
maldet --scan-recent PATH DAYS
# Scan files created/modified in the last X days (default: 7d, wildcard: ?)
maldet -r /home/?/public_html 2
```

## monitor

```sh
maldet -m
maldet --monitor USERS|PATHS|FILE|RELOAD #Run maldet with inotify kernel level file create/modify monitoring
maldet --monitor users
maldet --monitor /root/monitor_paths
maldet --monitor /home/mike,/home/ashton
```

- USERS
  The users option will take the homedirs of all system users that are above `inotify_minuid` and monitor them. 
  If `inotify_webdir` is set then the users webdir, if it exists, will only be monitored.
- PATHS
  A comma spaced list of paths to monitor. NO WILDCARDS!
- FILE
  paths will be extracted from file, line spaced

The alerting of file hits under monitor mode is handled through a daily report
instead of sending an email on every hit. The cron.daily job installed by LMD
will call an --alert-daily flag and send an alert for the last days hits. 

There is also an --alert-weekly option that can be used, simply edit the cron at
`/etc/cron.daily/maldet` and change the --alert-daily to --alert-weekly.

Terminating the inotify monitoring is done by passing the '-k|--kill-monitor'
option to maldet, it will touch a file handle monitored by maldet and on the
next waking cycle of the monitor service, it will terminate itself and all
inotify processes.